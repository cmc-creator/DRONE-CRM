// NyxAerial CRM - Prisma Schema
// https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────────
// WHITE-LABEL ORGANIZATION
// ─────────────────────────────────────────

model Organization {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique  // subdomain / URL key
  logoUrl         String?
  faviconUrl      String?
  primaryColor    String   @default("#00d4ff")
  accentColor     String   @default("#fbbf24")
  customDomain    String?  @unique
  supportEmail    String?
  stripeAccountId String?  // Stripe Connect account for payouts
  planTier        String   @default("starter") // starter | pro | enterprise
  active          Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  users           User[]

  @@map("organizations")
}

// ─────────────────────────────────────────
// AUTH / USERS
// ─────────────────────────────────────────

enum Role {
  ADMIN
  PILOT
  CLIENT
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          Role      @default(CLIENT)
  preferences   Json?     // { emailNewJob, emailPayment, emailCompliance, emailWeeklyDigest }
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // White-label org (null = default NyxAerial instance)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // NextAuth relations
  accounts      Account[]
  sessions      Session[]

  // Role-specific profiles
  pilot         Pilot?
  client        Client?

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ─────────────────────────────────────────
// PILOTS
// ─────────────────────────────────────────

enum PilotStatus {
  ACTIVE
  INACTIVE
  PENDING_REVIEW
  SUSPENDED
}

model Pilot {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal info
  phone           String?
  city            String?
  state           String?
  zip             String?
  bio             String?

  // FAA credentials
  faaPartNumber   String?     // Part 107 cert number
  faaExpiry       DateTime?
  faaDocUrl       String?     // uploaded cert document

  // Insurance
  insuranceCarrier   String?
  insurancePolicyNum String?
  insuranceExpiry    DateTime?
  insuranceDocUrl    String?

  // Business info
  businessName    String?
  w9OnFile        Boolean     @default(false)
  w9DocUrl        String?

  // Operational
  status          PilotStatus @default(PENDING_REVIEW)
  rating          Float?      // internal quality rating 1-5
  notes           String?

  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  markets         PilotMarket[]
  equipment       Equipment[]
  jobAssignments  JobAssignment[]
  complianceDocs  ComplianceDoc[]
  payments        PilotPayment[]
  contracts       Contract[]
  activities      Activity[]
  reviews         PilotReview[]
  availability    PilotAvailability[]

  @@map("pilots")
}

model PilotMarket {
  id        String   @id @default(cuid())
  pilotId   String
  pilot     Pilot    @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  state     String
  city      String?
  radius    Int?     // miles
  createdAt DateTime @default(now())

  @@map("pilot_markets")
}

model Equipment {
  id           String   @id @default(cuid())
  pilotId      String
  pilot        Pilot    @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  make         String   // e.g. DJI
  model        String   // e.g. Mavic 3 Pro
  serialNumber String?
  cameraSpec   String?
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("equipment")
}

// ─────────────────────────────────────────
// CLIENTS
// ─────────────────────────────────────────

enum ClientType {
  AGENCY
  COMMERCIAL
  REAL_ESTATE
  OTHER
}

enum ClientStatus {
  LEAD
  ACTIVE
  INACTIVE
  ARCHIVED
}

model Client {
  id          String       @id @default(cuid())
  userId      String?      @unique
  user        User?        @relation(fields: [userId], references: [id])

  // Company info
  companyName String
  contactName String?
  email       String?
  phone       String?
  website     String?
  type        ClientType   @default(OTHER)
  status      ClientStatus @default(LEAD)

  // Address
  address     String?
  city        String?
  state       String?
  zip         String?

  // Business
  billingEmail String?
  notes        String?
  source       String?  // how they found us

  // Stripe
  stripeCustomerId String?

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  jobs        Job[]
  invoices    Invoice[]
  contracts   Contract[]
  activities  Activity[]
  quoteRequests QuoteRequest[]

  @@map("clients")
}

// ─────────────────────────────────────────
// JOBS / PROJECTS
// ─────────────────────────────────────────

enum JobStatus {
  DRAFT
  PENDING_ASSIGNMENT
  ASSIGNED
  IN_PROGRESS
  CAPTURE_COMPLETE
  DELIVERED
  COMPLETED
  CANCELLED
}

enum JobType {
  REAL_ESTATE
  CONSTRUCTION
  MARKETING
  INSPECTION
  MAPPING
  EVENT
  OTHER
}

model Job {
  id            String    @id @default(cuid())
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id])

  // Job details
  title         String
  description   String?
  type          JobType   @default(OTHER)
  status        JobStatus @default(DRAFT)

  // Location
  address       String?
  city          String
  state         String
  zip           String?
  lat           Float?
  lng           Float?
  // Public tracking
  trackingToken String?   @unique
  // Scope
  scheduledDate DateTime?
  completedDate DateTime?
  duration      Int?      // estimated minutes
  deliverables  String?   // description of what to capture

  // Pricing
  clientPrice   Decimal?
  pilotPayout   Decimal?

  // Admin
  priority      Int       @default(2) // 1=high 2=normal 3=low
  internalNotes String?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignments   JobAssignment[]
  files         JobFile[]
  invoices      Invoice[]
  activities    Activity[]
  reviews       PilotReview[]
  messages      Message[]

  @@map("jobs")
}

model JobAssignment {
  id        String   @id @default(cuid())
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  pilotId   String
  pilot     Pilot    @relation(fields: [pilotId], references: [id])

  assignedAt  DateTime   @default(now())
  acceptedAt  DateTime?
  declinedAt  DateTime?
  notes       String?

  payment     PilotPayment?

  @@unique([jobId, pilotId])
  @@map("job_assignments")
}

// ─────────────────────────────────────────
// DELIVERABLES / FILES
// ─────────────────────────────────────────

enum FileType {
  PHOTO
  VIDEO
  RAW
  PROCESSED
  REPORT
  OTHER
}

model JobFile {
  id          String   @id @default(cuid())
  jobId       String
  job         Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  name        String
  url         String
  type        FileType @default(OTHER)
  sizeMb      Float?
  uploadedBy  String?  // user id
  isDelivered    Boolean  @default(false)
  deliveredAt    DateTime?

  // Client approval
  approvalStatus String   @default("PENDING") // PENDING | APPROVED | REVISION_REQUESTED
  approvalNote   String?
  reviewedAt     DateTime?

  createdAt      DateTime @default(now())

  @@map("job_files")
}

// ─────────────────────────────────────────
// INVOICING
// ─────────────────────────────────────────

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  VOID
  REFUNDED
}

model Invoice {
  id            String        @id @default(cuid())
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])
  jobId         String?
  job           Job?          @relation(fields: [jobId], references: [id])

  invoiceNumber String        @unique
  status        InvoiceStatus @default(DRAFT)
  amount        Decimal
  tax           Decimal?      @default(0)
  totalAmount   Decimal
  amountPaid    Decimal       @default(0)

  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  paidAt        DateTime?     // when payment was received

  // Stripe
  stripePaymentIntentId    String?
  stripeCheckoutSessionId  String?
  stripePaymentUrl         String?

  notes         String?
  lineItems     Json?         // array of {description, qty, unitPrice, total}

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("invoices")
}

enum PaymentStatus {
  PENDING
  APPROVED
  PAID
  VOID
}

model PilotPayment {
  id              String        @id @default(cuid())
  pilotId         String
  pilot           Pilot         @relation(fields: [pilotId], references: [id])
  assignmentId    String        @unique
  assignment      JobAssignment @relation(fields: [assignmentId], references: [id])

  amount          Decimal
  status          PaymentStatus @default(PENDING)
  method          String?       // check, zelle, ach, etc.

  approvedAt      DateTime?
  paidAt          DateTime?
  notes           String?

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("pilot_payments")
}

// ─────────────────────────────────────────
// COMPLIANCE DOCUMENTS
// ─────────────────────────────────────────

enum ComplianceDocType {
  FAA_PART107
  INSURANCE_COI
  W9
  BACKGROUND_CHECK
  EQUIPMENT_CERT
  OTHER
}

enum ComplianceDocStatus {
  PENDING
  APPROVED
  EXPIRED
  REJECTED
}

model ComplianceDoc {
  id        String              @id @default(cuid())
  pilotId   String
  pilot     Pilot               @relation(fields: [pilotId], references: [id], onDelete: Cascade)

  type      ComplianceDocType
  status    ComplianceDocStatus @default(PENDING)
  docUrl    String?
  docName   String?
  expiresAt DateTime?
  notes     String?
  reviewedBy String?
  reviewedAt DateTime?

  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  @@map("compliance_docs")
}

// ─────────────────────────────────────────
// CONTRACTS & E-SIGNATURES
// ─────────────────────────────────────────

enum ContractStatus {
  DRAFT
  SENT
  SIGNED
  VOID
}

enum ContractType {
  PILOT_AGREEMENT
  CLIENT_SERVICE
  NDA
  SUBCONTRACTOR
  OTHER
}

model Contract {
  id              String         @id @default(cuid())
  title           String
  type            ContractType   @default(OTHER)
  status          ContractStatus @default(DRAFT)

  // Parties (optional — can be for pilot, client, or standalone)
  clientId        String?
  client          Client?        @relation(fields: [clientId], references: [id])
  pilotId         String?
  pilot           Pilot?         @relation(fields: [pilotId], references: [id])

  // Content (plain text or HTML)
  content         String

  // E-signature
  signedAt        DateTime?
  signedByName    String?
  signedByEmail   String?
  signatureIp     String?

  // Admin
  sentAt          DateTime?
  notes           String?

  // Timestamps
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@map("contracts")
}

// ── Lead Pipeline ──────────────────────────────────────────────────────────────

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  PROPOSAL_SENT
  NEGOTIATING
  WON
  LOST
}

enum LeadSource {
  REFERRAL
  WEBSITE
  SOCIAL_MEDIA
  COLD_OUTREACH
  REPEAT_CLIENT
  TRADE_SHOW
  OTHER
}

model Lead {
  id           String     @id @default(cuid())
  companyName  String
  contactName  String
  email        String?
  phone        String?
  status       LeadStatus @default(NEW)
  source       LeadSource @default(OTHER)
  value        Float?     // estimated deal value
  notes        String?
  nextFollowUp DateTime?
  assignedTo   String?    // userId
  activities   Activity[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("leads")
}

// ── Activity / CRM Timeline ────────────────────────────────────────────────────

enum ActivityType {
  CALL
  EMAIL
  NOTE
  MEETING
  TASK
  QUOTE_SENT
  FLIGHT_COMPLETED
}

model Activity {
  id          String       @id @default(cuid())
  type        ActivityType @default(NOTE)
  title       String
  body        String?
  dueDate     DateTime?
  completed   Boolean      @default(false)
  createdById String?

  // Link to any entity (all optional — link to what's relevant)
  leadId      String?
  lead        Lead?    @relation(fields: [leadId], references: [id])
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])
  pilotId     String?
  pilot       Pilot?   @relation(fields: [pilotId], references: [id])
  jobId       String?
  job         Job?     @relation(fields: [jobId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("activities")
}

// ── Pilot Reviews ──────────────────────────────────────────────────────────────

model PilotReview {
  id          String   @id @default(cuid())
  pilotId     String
  pilot       Pilot    @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  jobId       String?
  job         Job?     @relation(fields: [jobId], references: [id])

  rating      Int      // 1-5 stars
  comment     String?
  reviewedBy  String?  // admin user id
  createdAt   DateTime @default(now())

  @@map("pilot_reviews")
}

// ── Public Quote Requests ──────────────────────────────────────────────────────

enum QuoteStatus {
  NEW
  REVIEWED
  CONVERTED
  DISMISSED
}

model QuoteRequest {
  id          String      @id @default(cuid())
  name        String
  email       String
  phone       String?
  company     String?
  city        String?
  state       String?
  serviceType String?
  description String?
  budget      String?
  status      QuoteStatus @default(NEW)

  // If converted to lead/client
  clientId    String?
  client      Client?  @relation(fields: [clientId], references: [id])

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("quote_requests")
}

// ── In-app Messaging ───────────────────────────────────────────────────────────

model Message {
  id         String   @id @default(cuid())
  jobId      String?
  job        Job?     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  senderId   String
  senderName String?
  senderRole String   // ADMIN | CLIENT | PILOT
  body       String
  readAt     DateTime?
  createdAt  DateTime @default(now())

  @@map("messages")
}

// ── Pilot Availability ─────────────────────────────────────────────────────────

model PilotAvailability {
  id        String   @id @default(cuid())
  pilotId   String
  pilot     Pilot    @relation(fields: [pilotId], references: [id], onDelete: Cascade)
  date      DateTime
  available Boolean  @default(true)
  startTime String?  // "08:00"
  endTime   String?  // "17:00"
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([pilotId, date])
  @@map("pilot_availability")
}
